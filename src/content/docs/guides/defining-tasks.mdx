---
title: Defining tasks
description: Wrap functions with task() and export them.
sidebar:
  order: 1
---

Task wraps a function so workers can discover and run
it. Tasks should be defined at module scope and exported.

```ts
type Task = {
  f: (uknown) => uknown,
  createPool?: (options: CreatePool) => SingleTaskPool,
  timeout?: number | {
    time: number;
    maybe?: true;
    default?: unknown;
    error?: unknown;
  }
}

```

## Guidelines

- Define tasks at module scope (no conditional exports).
- Export tasks from the module where they are defined.
- Prefer a single argument; use a tuple or object for multiple values.
- Better to be on it's own file

### Simple task

Tasks are basically a fix point where the worker can import them with all the context of the file

```ts
import { task } from "@vixeny/knitting";

export const hello = task({
  f: async () => "hello",
});
```

### Task with arguments

Return type can be infer by used but the arguments has to be typed.

```ts
export const add = task({
  f: async ([a, b] : [number, number]) => a + b,
});
```

Or:

```ts
export const add = task<[number, number], number>({
  f: async ([a, b]) => a + b,
});
```

### Promises and resolution

Something important about Knitting behaivour is that it will wait for a promise until this one resolves,
no mattering the level of nesting:

```js
import { isMain, task } from "@vixeny/knitting";

export const world = task({
  f: (str: string ) => str + "world",
}).createPool();

const promise = Promise.resolve("hello")

if (isMain) {
  world.call(promise)
    .then(console.log)
    .finally(world.shutdown)
}

```

:::caution
If this where to be rejected, the rejection will be passed to the promise.
:::


## Optionals

You can easily modify the behaivour adding options to a task.

### Single-task pool

```ts
import { isMain, task } from "@vixeny/knitting";

export const world = task({
  f: async () => "world",
}).createPool({
  threads: 2,
});

if (isMain) {
  const results = await Promise.all([world.call()]);
  console.log("Results:", results);
  world.shutdown();
}
```

### Timeout

Supported forms:

- `number` (ms). Non-negative values reject with `Error("Task timeout")`.
- `{ time: number, default: value }` resolves with the provided value.
- `{ time: number, maybe: true }` resolves with `undefined`.
- `{ time: number, error: value }` rejects with the provided error.

If `time` is negative or missing, timeouts are ignored.
```ts
export const maybeSlow = task<string, string>({
  timeout: { time: 50, default: "timeout" },
  f: async (value) => value,
});
```


:::note

Timeouts race the task result; the underlying work may still complete even if
its promise resolves or rejects early.

:::
