---
const {
  caption = "Host calls write into a shared request mailbox; workers execute tasks and write results into a shared response mailbox.",
} = Astro.props as {
  caption?: string;
};
---

<figure class="knitting-arch not-content">
  <div
    class="diagram"
    role="img"
    aria-label="Knitting architecture diagram: host call writes to a shared-memory request mailbox, workers read and execute tasks, workers write results to a shared-memory response mailbox, and the host resolves the promise."
  >
    <div class="node">
      <div class="title">Host</div>
      <div class="meta">main thread</div>
      <div class="detail"><code>call.*()</code></div>
    </div>
    <div class="arrow" aria-hidden="true">→</div>
    <div class="node sab">
      <div class="title">Request</div>
      <div class="meta">SharedArrayBuffer mailbox</div>
      <div class="detail">slots + bitset ownership</div>
    </div>
    <div class="arrow" aria-hidden="true">→</div>
    <div class="node">
      <div class="title">Workers</div>
      <div class="meta">threads (lanes)</div>
      <div class="detail">execute <code>task(&#123; f &#125;)</code></div>
    </div>
    <div class="arrow" aria-hidden="true">→</div>
    <div class="node sab">
      <div class="title">Response</div>
      <div class="meta">SharedArrayBuffer mailbox</div>
      <div class="detail">results + wakeups</div>
    </div>
    <div class="arrow" aria-hidden="true">→</div>
    <div class="node">
      <div class="title">Host</div>
      <div class="meta">main thread</div>
      <div class="detail">resolve <code>Promise</code></div>
    </div>
  </div>
  <figcaption>{caption}</figcaption>
</figure>

<style>
  .knitting-arch{
    --bg: rgba(255, 255, 255, 0.72);
    --node-bg: rgba(249, 250, 251, 0.75);
    --border: rgba(15, 23, 42, 0.12);
    --fg: rgba(15, 23, 42, 0.92);
    --muted: rgba(15, 23, 42, 0.68);
    --sab: rgba(52, 211, 153, 0.18);
    margin: 14px 0 18px;
  }

  :global(:root[data-theme='dark']) .knitting-arch{
    --bg: rgba(15, 23, 42, 0.5);
    --node-bg: rgba(15, 23, 42, 0.58);
    --border: rgba(148, 163, 184, 0.22);
    --fg: rgba(241, 245, 249, 0.92);
    --muted: rgba(203, 213, 225, 0.72);
    --sab: rgba(52, 211, 153, 0.12);
  }

  .diagram{
    display: flex;
    align-items: stretch;
    gap: 10px;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--bg);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .node{
    flex: 0 0 auto;
    min-width: 160px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--node-bg);
    color: var(--fg);
  }

  .node.sab{
    background: linear-gradient(180deg, var(--node-bg), var(--sab));
  }

  .title{
    font-weight: 650;
    font-size: 14px;
    line-height: 1.15;
    letter-spacing: -0.01em;
  }

  .meta{
    margin-top: 2px;
    font-size: 12px;
    line-height: 1.25;
    color: var(--muted);
  }

  .detail{
    margin-top: 8px;
    font-size: 12px;
    line-height: 1.3;
    color: var(--fg);
  }

  .arrow{
    flex: 0 0 auto;
    align-self: center;
    opacity: 0.7;
    color: var(--muted);
    font-size: 16px;
    user-select: none;
  }

  figcaption{
    margin-top: 10px;
    font-size: 12px;
    line-height: 1.35;
    color: var(--muted);
  }

  code{
    font-size: 0.95em;
  }
</style>
